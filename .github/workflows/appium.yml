name: Appium Tests

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: windows-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Set up Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Install dependencies
      run: |
        npm install -g appium
        npm install

    - name: Start Appium server
      shell: powershell
      run: Start-Process -NoNewWindow -FilePath "cmd.exe" -ArgumentList "/c appium" -RedirectStandardOutput "appium.log" -RedirectStandardError "appium-error.log"

    - name: Wait for Appium to be ready
      shell: powershell
      run: |
        $timeout = 30
        $elapsed = 0
        do {
          Start-Sleep -Seconds 2
          $elapsed += 2
          $result = Test-NetConnection -ComputerName 127.0.0.1 -Port 4723 -WarningAction SilentlyContinue
        } while (-not $result.TcpTestSucceeded -and $elapsed -lt $timeout)
        if (-not $result.TcpTestSucceeded) { throw "Appium did not start in time" }

    - name: Run tests
      run: node test_sample.js

    - name: Print Appium logs on failure
      if: failure()
      shell: powershell
      run: |
        Get-Content appium.log -ErrorAction SilentlyContinue
        Get-Content appium-error.log -ErrorAction SilentlyContinue
