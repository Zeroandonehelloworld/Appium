name: Appium Tests

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: windows-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Set up Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '20'

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Install dependencies
      run: |
        npm install -g appium@3
        npm install appium@3 --save
        npm install

    - name: Install Appium Windows Driver
      run: appium driver install windows

    - name: Start Appium server
      shell: powershell
      run: |
        $globalRoot = npm root -g
        $appiumJs = "$globalRoot\appium\index.js"
        Write-Host "Launching: node $appiumJs"
        Start-Process -NoNewWindow -FilePath "node.exe" -ArgumentList $appiumJs -RedirectStandardOutput "appium.log" -RedirectStandardError "appium-error.log"

    - name: Wait for Appium to be ready
      shell: powershell
      run: |
        $timeout = 60
        $elapsed = 0
        $ready = $false
        while ($elapsed -lt $timeout) {
          Start-Sleep -Seconds 2
          $elapsed += 2
          $statusCode = curl.exe -s -o NUL -w "%{http_code}" http://127.0.0.1:4723/status
          Write-Host "HTTP status: $statusCode ($elapsed s elapsed)"
          if ($statusCode -eq "200") {
            Write-Host "Appium is ready!"
            $ready = $true
            break
          }
        }
        if (-not $ready) { throw "Appium did not start in time" }

    - name: Run tests
      run: node test_sample.js

    - name: Print Appium logs
      if: always()
      shell: powershell
      run: |
        Write-Host "=== appium.log ==="
        Get-Content appium.log -ErrorAction SilentlyContinue
        Write-Host "=== appium-error.log ==="
        Get-Content appium-error.log -ErrorAction SilentlyContinue
