name: Appium Tests

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: windows-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Set up Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Install dependencies
      run: |
        npm install -g appium       # Install Appium globally
        npm install                 # Install project dependencies (e.g., WebdriverIO)

    - name: Start Appium server
      shell: powershell
      run: |
        # Start Appium in a separate process
        Start-Process appium

        # Wait until Appium is ready on port 4723
        $timeout = 60
        $elapsed = 0
        while (-not (Test-NetConnection -ComputerName 127.0.0.1 -Port 4723).TcpTestSucceeded) {
          Write-Host "Waiting for Appium to start..."
          Start-Sleep -Seconds 2
          $elapsed += 2
          if ($elapsed -ge $timeout) {
            Write-Error "Appium did not start in $timeout seconds."
            exit 1
          }
        }
        Write-Host "Appium server is ready!"

    - name: Run tests
      run: node test_sample.js
