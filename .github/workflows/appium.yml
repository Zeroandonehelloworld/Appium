name: Appium Tests

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: windows-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4   # updated to latest version

    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Install Appium globally
      run: npm install -g appium

    # Optional: install needed drivers (uncomment what you need)
    # - name: Install UiAutomator2 driver (Android)
    #   run: appium driver install uiautomator2
    #
    # - name: Install XCUITest driver (iOS - simulator only on Windows is limited)
    #   run: appium driver install xcuitest

    - name: Install project dependencies
      run: npm install

    - name: Start Appium server in background
      shell: pwsh
      run: |
        Start-Process -NoNewWindow appium `
          -ArgumentList "--address", "0.0.0.0", "--port", "4723", "--log", "appium.log" `
          -RedirectStandardOutput "appium-out.log" `
          -RedirectStandardError "appium-err.log"

    - name: Wait for Appium server to be ready
      shell: pwsh
      run: |
        $maxAttempts = 40
        $attempt = 0

        do {
          Start-Sleep -Seconds 2
          $attempt++
          try {
            $response = Invoke-WebRequest -Uri "http://127.0.0.1:4723/status" `
              -UseBasicParsing -TimeoutSec 4 -Method Get
            if ($response.StatusCode -eq 200) {
              Write-Output "Appium is ready! (attempt $attempt)"
              break
            }
          }
          catch {
            Write-Output "Still waiting... ($attempt/$maxAttempts)"
          }
        } while ($attempt -lt $maxAttempts)

        if ($attempt -eq $maxAttempts) {
          Write-Error "Appium failed to start after $maxAttempts attempts"
          Get-Content appium.log -ErrorAction SilentlyContinue
          Get-Content appium-out.log -ErrorAction SilentlyContinue
          Get-Content appium-err.log -ErrorAction SilentlyContinue
          exit 1
        }

    - name: Run tests
      run: node test_sample.js

    # Very useful for debugging â€“ always show logs when job fails or succeeds
    - name: Show Appium logs (always)
      if: always()
      shell: pwsh
      run: |
        Write-Output "=== Appium main log ==="
        Get-Content appium.log -ErrorAction SilentlyContinue
        Write-Output "`n=== Appium stdout ==="
        Get-Content appium-out.log -ErrorAction SilentlyContinue
        Write-Output "`n=== Appium stderr ==="
        Get-Content appium-err.log -ErrorAction SilentlyContinue
